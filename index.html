<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Regina Golf App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA CONFIG -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#5B6F3A">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
  <!-- END PWA CONFIG -->

  <!-- Excel reader (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --green-dark:#5B6F3A;
      --green-mid:#8FA76A;
      --green-light:#C9D8A5;
      --bg-main:#F3F5EC;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      margin:0;
      padding:1rem;
    }

    .app{
      max-width:900px;
      margin:0 auto;
      background:#fff;
      padding:1.5rem;
      border-radius:16px;
      border:3px solid var(--green-light);
      box-shadow:0 3px 10px rgba(0,0,0,0.12);
    }

    .logo-wrap{text-align:center;margin-bottom:.5rem;}
    .logo-img{max-width:140px;height:auto;}

    h1{
      text-align:center;
      font-size:1.6rem;
      color:var(--green-dark);
      margin:.25rem 0 1rem 0;
    }
    h2{color:var(--green-dark);font-size:1.1rem;margin-top:1.5rem;}
    h3{color:var(--green-dark);font-size:1rem;margin-top:1rem;}

    .top-row{
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      border-bottom:1px solid var(--green-light);
      padding-bottom:.5rem;
      margin-bottom:1rem;
      align-items:center;
    }

    select,input,button,textarea{
      border-radius:6px;
      border:1px solid var(--green-light);
      font-size:.9rem;
      padding:.4rem .6rem;
    }

    button{
      background:var(--green-dark);
      color:#fff;
      border:none;
      cursor:pointer;
      transition:.15s;
    }
    button:hover{background:#4a5b30;}

    #playersContainer{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(190px,1fr));
      gap:.4rem;
      background:#fafcf7;
      border-radius:10px;
      padding:.5rem;
      border:1px solid var(--green-light);
    }

    .players-list label{
      display:inline-flex;
      align-items:center;
      gap:.3rem;
    }

    .group-card{
      margin:.4rem 0;
      background:#fafcf7;
      padding:.6rem .7rem;
      border-radius:10px;
      border:1px solid var(--green-light);
    }

    .guest-item{
      display:flex;
      justify-content:space-between;
      font-size:.85rem;
      margin:.25rem 0;
      gap:.5rem;
      align-items:center;
    }
    .guest-item button{
      background:#b84747;
      padding:.15rem .5rem;
      font-size:.7rem;
    }

    .badge{
      display:inline-block;
      padding:.1rem .45rem;
      border-radius:999px;
      background:var(--green-light);
      color:#2f3a21;
      font-size:.75rem;
      margin-left:.35rem;
    }

    .note{font-size:.8rem;color:#516044;margin:.2rem 0;}
    .strokes{font-size:.75rem;color:#444;}

    .scorecard{
      margin:.5rem 0 1rem;
      padding:.5rem;
      border-radius:10px;
      background:#fafcf7;
      border:1px solid var(--green-light);
    }

    textarea{
      width:100%;
      min-height:90px;
      margin-top:.5rem;
      border-radius:8px;
      border:1px solid var(--green-light);
      padding:.5rem;
      background:#fafcf7;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="logo-wrap">
    <img src="regina-logo.png" class="logo-img" alt="Regina logo">
  </div>

  <h1>Regina Golf – Pareo y Resultados</h1>

  <div class="top-row">
    <div>
      <label>Tipo de ronda:<br>
        <select id="roundType">
          <option value="regular">Ronda Regular</option>
          <option value="mensual">Torneo Mensual</option>
        </select>
      </label>
    </div>

    <div>
      <label>Formato de juego:<br>
        <select id="gameFormat">
          <option value="stroke">Stroke play</option>
          <option value="stableford">Stableford</option>
          <option value="match">Match play</option>
        </select>
      </label>
    </div>

    <button id="generateBtn">Generar Pareos</button>
  </div>

  <!-- Tee times -->
  <h2>Tee times</h2>
  <p class="note">Seleccione las horas disponibles para salida por hoyo 1 y hoyo 10.</p>

  <div class="top-row" style="align-items:flex-end;">
    <div style="min-width:260px;">
      <label>Hoyo 1 (selección múltiple):<br>
        <select id="teeTimesHole1" multiple size="6" style="width:100%;">
          <option value="06:20">6:20</option>
          <option value="06:30">6:30</option>
          <option value="06:40">6:40</option>
          <option value="06:50">6:50</option>
          <option value="07:00">7:00</option>
          <option value="07:10">7:10</option>
        </select>
      </label>
    </div>

    <div style="min-width:260px;">
      <label>Hoyo 10 (selección múltiple):<br>
        <select id="teeTimesHole10" multiple size="6" style="width:100%;">
          <option value="06:20">6:20</option>
          <option value="06:30">6:30</option>
          <option value="06:40">6:40</option>
          <option value="06:50">6:50</option>
          <option value="07:00">7:00</option>
          <option value="07:10">7:10</option>
        </select>
      </label>
    </div>

    <div style="min-width:220px;">
      <button id="applyTeeTimesBtn" style="background:#8FA76A">Usar seleccionados</button>
      <button id="clearTeeTimesBtn" style="background:#9da8a0">Limpiar</button>
    </div>
  </div>
  <div id="teeTimesSummary" class="note"></div>

  <!-- Excel upload -->
  <h2>Actualizar HCP (Excel)</h2>
  <p class="note">
    Suba un Excel con columnas: <strong>Nombre</strong> y <strong>HCP</strong> (o Handicap). Actualiza handicaps en esta sesión.
  </p>
  <div class="top-row" style="border-bottom:none; padding-bottom:0; margin-bottom:.25rem;">
    <input type="file" id="hcpExcelInput" accept=".xlsx,.xls" />
    <button id="applyHcpBtn" style="background:#8FA76A">Actualizar handicaps</button>
    <div id="hcpUploadStatus" class="note"></div>
  </div>

  <h2>Jugadores hoy</h2>
  <p class="note">Marque quiénes juegan hoy. Todos son socios del grupo.</p>

  <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
    <button id="selectAllBtn" style="background:#8FA76A">Seleccionar todos</button>
    <button id="deselectAllBtn" style="background:#9da8a0">Deseleccionar todos</button>
  </div>

  <div id="playersContainer" class="players-list"></div>

  <h2>Invitados</h2>
  <label>Anfitrión:</label><br>
  <select id="guestHostSelect"></select>
  <br><br>

  <input id="guestNameInput" placeholder="Nombre invitado">
  <input id="guestHcpInput" type="number" placeholder="HCP" style="width:120px;">
  <button id="addGuestBtn">Agregar invitado</button>

  <div id="guestsList" class="note" style="margin-top:.5rem;"></div>

  <h2>Pareos</h2>
  <div id="groupsContainer"></div>

  <h3>Tarjetas Match Play</h3>
  <div id="scorecardsContainer"></div>

  <h3>Copiar a WhatsApp</h3>
  <textarea id="exportText" readonly></textarea>

  <!-- Keep your original Results logic if you had it; this file focuses on pairings + tee times + excel update -->
</div>

<script>
/* ========= DATA ========= */

const players = [
  "Gilberto Acosta","Phillippe Arnoux","Luis Beltran","Murielle Borgeaud",
  "Carlos Braddick","Olga Brooks","Hope Bullock III","Cecil Casasola",
  "Jose Casasola","Federico Cockburn","Manuel Cordova","Clarissa Corro",
  "Rodolfo Fuentes","David Gomez","Pedro Gonzalez","Carlos Gonzalez",
  "Luis Gordon","Cesar Hall","Edilberto Hernandez","Jose Leal",
  "Sara Lin","Luis Llorach","Sofia Llorach","Tony Martinez",
  "Fouad Moutran","Heriberto Olier","Julio Ortiz","BK Patel",
  "Raul Orillac","Rui Tulha","Daniel Ribeiro","Jose Serracin",
  "Pancho Townsend","Antonio Villarreal","Jose Von Chong"
];

// Initial handicaps (Excel upload can overwrite these)
const handicaps = {
  "Gilberto Acosta": -1,
  "Phillippe Arnoux": 21,
  "Luis Beltran": 19,
  "Murielle Borgeaud": 28,
  "Carlos Braddick": 11,
  "Olga Brooks": 11,
  "Hope Bullock III": 10,
  "Cecil Casasola": 6,
  "Jose Casasola": 7,
  "Federico Cockburn": 15,
  "Manuel Cordova": 40,
  "Clarissa Corro": 22,
  "Rodolfo Fuentes": 15,
  "David Gomez": 30,
  "Pedro Gonzalez": 5,
  "Carlos Gonzalez": 14,
  "Luis Gordon": 9,
  "Cesar Hall": 4,
  "Edilberto Hernandez": 8,
  "Jose Leal": 13,
  "Sara Lin": 27,
  "Luis Llorach": 20,
  "Sofia Llorach": 11,
  "Tony Martinez": 23,
  "Fouad Moutran": 8,
  "Heriberto Olier": 30,
  "Julio Ortiz": 7,
  "BK Patel": 10,
  "Raul Orillac": 14,
  "Rui Tulha": 15,
  "Daniel Ribeiro": 27,
  "Jose Serracin": 14,
  "Pancho Townsend": 13,
  "Antonio Villarreal": 22,
  "Jose Von Chong": 25
};

/* ========= SPECIAL RESTRICTIONS (YOUR RULES) ========= */

const FOUAD = "Fouad Moutran";

// Fouad only plays with the following (priority order)
const FOUAD_ALLOWED_PARTNERS = [
  "Pancho Townsend",
  "Hope Bullock III",
  "Rodolfo Fuentes",
  "Pedro Gonzalez",
  "Antonio Villarreal",
  "Carlos Braddick"
];

// Avoid pairing Olga with:
const OLGA_CANNOT_PLAY_WITH = [
  "Clarissa Corro",
  "Antonio Villarreal",
  "Luis Llorach",
  "Sara Lin"
];

/* ========= STATE ========= */

let guests = [];   // {name, hcp, host}
let teeSlots = []; // {time:"HH:MM", startHole:1|10}
let lastGroups = [];

/* ========= HELPERS ========= */

function normalizeName(s){
  return (s || "")
    .toString()
    .trim()
    .replace(/\s+/g, " ")
    .toLowerCase();
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function shuffle(arr){
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function isGuest(p){ return p?.type === "guest"; }
function isMember(p){ return p?.type === "member"; }

function getSelectedPlayers(){
  const checks = Array.from(document.querySelectorAll(".playerCheck"));
  return checks.filter(c => c.checked).map(c => c.value);
}

/* ========= RENDER PLAYERS / HOST SELECT ========= */

function renderPlayers(){
  const container = document.getElementById("playersContainer");
  container.innerHTML = players.map(p => {
    const h = (handicaps[p] ?? "—");
    return `
      <label>
        <input type="checkbox" class="playerCheck" value="${escapeHtml(p)}">
        ${escapeHtml(p)} <span class="strokes">(HCP: ${escapeHtml(h)})</span>
      </label>
    `;
  }).join("");

  const host = document.getElementById("guestHostSelect");
  host.innerHTML =
    `<option value="">(Seleccione anfitrión)</option>` +
    players.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
}

document.getElementById("selectAllBtn").addEventListener("click", () => {
  document.querySelectorAll(".playerCheck").forEach(c => c.checked = true);
});
document.getElementById("deselectAllBtn").addEventListener("click", () => {
  document.querySelectorAll(".playerCheck").forEach(c => c.checked = false);
});

/* ========= GUESTS ========= */

function renderGuests(){
  const el = document.getElementById("guestsList");
  if (!guests.length){
    el.innerHTML = "<em>No hay invitados.</em>";
    return;
  }
  el.innerHTML = guests.map((g, idx) => `
    <div class="guest-item">
      <div>
        <strong>${escapeHtml(g.name)}</strong>
        <span class="badge">HCP: ${escapeHtml(g.hcp)}</span>
        <span class="badge">Host: ${escapeHtml(g.host || "—")}</span>
      </div>
      <button onclick="removeGuest(${idx})">X</button>
    </div>
  `).join("");
}

window.removeGuest = function(idx){
  guests.splice(idx, 1);
  renderGuests();
};

document.getElementById("addGuestBtn").addEventListener("click", () => {
  const host = document.getElementById("guestHostSelect").value.trim();
  const name = document.getElementById("guestNameInput").value.trim();
  const hcp = Number(document.getElementById("guestHcpInput").value);

  if (!name){ alert("Ingrese nombre del invitado."); return; }
  if (!Number.isFinite(hcp)){ alert("Ingrese un HCP numérico para el invitado."); return; }

  guests.push({ name, hcp, host });
  document.getElementById("guestNameInput").value = "";
  document.getElementById("guestHcpInput").value = "";
  renderGuests();
});

/* ========= TEE TIMES ========= */

const teeTimesHole1 = document.getElementById("teeTimesHole1");
const teeTimesHole10 = document.getElementById("teeTimesHole10");
const applyTeeTimesBtn = document.getElementById("applyTeeTimesBtn");
const clearTeeTimesBtn = document.getElementById("clearTeeTimesBtn");
const teeTimesSummary = document.getElementById("teeTimesSummary");

function getSelectedValues(selectEl){
  return Array.from(selectEl.selectedOptions).map(o => o.value);
}

function renderTeeSummary(){
  if (!teeSlots.length){
    teeTimesSummary.innerHTML = "<em>No hay tee times seleccionados.</em>";
    return;
  }
  const byHole = {1:[], 10:[]};
  teeSlots.forEach(s => byHole[s.startHole].push(s.time));
  teeTimesSummary.innerHTML =
    `<strong>Hoyo 1:</strong> ${byHole[1].join(", ") || "—"}<br>` +
    `<strong>Hoyo 10:</strong> ${byHole[10].join(", ") || "—"}`;
}

applyTeeTimesBtn.addEventListener("click", () => {
  const h1 = getSelectedValues(teeTimesHole1).sort();
  const h10 = getSelectedValues(teeTimesHole10).sort();
  teeSlots = [
    ...h1.map(t => ({ time: t, startHole: 1 })),
    ...h10.map(t => ({ time: t, startHole: 10 }))
  ];
  renderTeeSummary();
});

clearTeeTimesBtn.addEventListener("click", () => {
  teeSlots = [];
  Array.from(teeTimesHole1.options).forEach(o => o.selected = false);
  Array.from(teeTimesHole10.options).forEach(o => o.selected = false);
  renderTeeSummary();
});

renderTeeSummary();

/* ========= EXCEL UPLOAD ========= */

const hcpExcelInput = document.getElementById("hcpExcelInput");
const applyHcpBtn = document.getElementById("applyHcpBtn");
const hcpUploadStatus = document.getElementById("hcpUploadStatus");

function findHeaderIndex(headers, candidates){
  for (const c of candidates){
    const idx = headers.indexOf(normalizeName(c));
    if (idx !== -1) return idx;
  }
  return -1;
}

function parseNumber(val){
  if (val === null || val === undefined) return null;
  if (typeof val === "number") return val;
  const s = val.toString().trim().replace(",", ".");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

applyHcpBtn.addEventListener("click", async () => {
  const file = hcpExcelInput.files?.[0];
  if (!file){
    hcpUploadStatus.textContent = "Seleccione un archivo Excel primero.";
    return;
  }

  try {
    const arrayBuffer = await file.arrayBuffer();
    const wb = XLSX.read(arrayBuffer, { type: "array" });

    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });

    if (!rows.length){
      hcpUploadStatus.textContent = "El archivo está vacío.";
      return;
    }

    const headerRow = rows[0].map(h => normalizeName(h));
    const nameCol = findHeaderIndex(headerRow, ["nombre", "name", "player", "jugador"]);
    const hcpCol  = findHeaderIndex(headerRow, ["hcp", "handicap", "index"]);

    if (nameCol === -1 || hcpCol === -1){
      hcpUploadStatus.innerHTML =
        "No encontré columnas válidas. Use encabezados como <strong>Nombre</strong> y <strong>HCP</strong> (o Handicap).";
      return;
    }

    const playerMap = new Map();
    players.forEach(p => playerMap.set(normalizeName(p), p));

    let updated = 0, skippedNotFound = 0, skippedBad = 0;

    for (let r = 1; r < rows.length; r++){
      const row = rows[r];
      if (!row || row.length === 0) continue;

      const rawName = row[nameCol];
      const rawHcp = row[hcpCol];

      const key = normalizeName(rawName);
      if (!key) continue;

      const canonical = playerMap.get(key);
      if (!canonical){ skippedNotFound++; continue; }

      const h = parseNumber(rawHcp);
      if (h === null){ skippedBad++; continue; }

      handicaps[canonical] = h;
      updated++;
    }

    renderPlayers();

    hcpUploadStatus.innerHTML =
      `Listo. Actualizados: <strong>${updated}</strong>. ` +
      `No encontrados: <strong>${skippedNotFound}</strong>. ` +
      `HCP inválido: <strong>${skippedBad}</strong>.`;

  } catch (err){
    console.error(err);
    hcpUploadStatus.textContent = "Error leyendo el Excel. Revise el formato del archivo.";
  }
});

/* ========= RESTRICTIONS ENGINE (FOUAD + OLGA) ========= */

function fouadCanBeGroupedWith(otherObj){
  if (!otherObj) return true;

  // Fouad can play with allowed member partners
  if (isMember(otherObj)){
    return otherObj.name === FOUAD || FOUAD_ALLOWED_PARTNERS.includes(otherObj.name);
  }

  // Guests: allow if host is Fouad OR host is one of Fouad's allowed partners
  if (isGuest(otherObj)){
    const host = (otherObj.host || "").trim();
    return host === FOUAD || FOUAD_ALLOWED_PARTNERS.includes(host);
  }

  return false;
}

function violatesOlgaRule(group){
  const names = group.players.map(p => p.name);
  if (!names.includes("Olga Brooks")) return false;
  return OLGA_CANNOT_PLAY_WITH.some(n => names.includes(n));
}

function buildFouadGroupIfPlaying(allPlayers){
  const fouadIndex = allPlayers.findIndex(p => p.name === FOUAD);
  if (fouadIndex === -1) return { fouadGroup: null, remaining: allPlayers.slice() };

  const remaining = allPlayers.slice();
  const fouadObj = remaining.splice(fouadIndex, 1)[0];

  const group = { players: [fouadObj], teeTime:null, startHole:null };

  // Add allowed partners in priority order (members)
  for (const partnerName of FOUAD_ALLOWED_PARTNERS){
    if (group.players.length >= 4) break;
    const idx = remaining.findIndex(p => p.name === partnerName);
    if (idx !== -1){
      const candidate = remaining[idx];
      if (fouadCanBeGroupedWith(candidate)){
        group.players.push(remaining.splice(idx, 1)[0]);
      }
    }
  }

  // If still space, fill with guests invited by Fouad or allowed partners
  for (let i = 0; i < remaining.length && group.players.length < 4; ){
    const candidate = remaining[i];
    if (isGuest(candidate) && fouadCanBeGroupedWith(candidate)){
      group.players.push(remaining.splice(i, 1)[0]);
    } else {
      i++;
    }
  }

  // If still not full, leave as 2–3 players (do NOT violate "only plays with")
  return { fouadGroup: group, remaining };
}

function generateGroupsWithFouadAndOlgaRules(playerObjs){
  const warnings = [];

  const { fouadGroup, remaining } = buildFouadGroupIfPlaying(playerObjs);
  const pool = shuffle(remaining);

  const groups = [];
  if (fouadGroup) groups.push(fouadGroup);

  for (const p of pool){
    let placed = false;

    // Try add to existing group
    for (const g of groups){
      if (g.players.length >= 4) continue;

      const hasFouad = g.players.some(x => x.name === FOUAD);
      if (hasFouad && !fouadCanBeGroupedWith(p)) continue;

      const testGroup = { players: g.players.concat([p]) };
      if (violatesOlgaRule(testGroup)) continue;

      g.players.push(p);
      placed = true;
      break;
    }

    if (!placed){
      // start new group (but if p is not allowed with Fouad, that's fine because Fouad is already grouped)
      groups.push({ players: [p], teeTime:null, startHole:null });
    }
  }

  // Warn if Olga violation exists (should be avoided; if constraints forced it, warn)
  groups.forEach((g, idx) => {
    if (violatesOlgaRule(g)){
      warnings.push(`Grupo ${idx+1}: Olga Brooks con pareja no permitida`);
    }
  });

  return { groups, warnings };
}

/* ========= ASSIGN TEE TIMES (FOUAD EARLIEST) ========= */

function assignTeeSlotsToGroups(groups){
  // earliest by time regardless of hole
  const slots = (teeSlots || []).slice().sort((a,b) => a.time.localeCompare(b.time));

  const fouadGroupIndex = groups.findIndex(g => g.players.some(p => p.name === FOUAD));

  // Reserve earliest for Fouad group
  if (slots.length && fouadGroupIndex !== -1){
    const earliest = slots.shift();
    groups[fouadGroupIndex].teeTime = earliest.time;
    groups[fouadGroupIndex].startHole = earliest.startHole;
  }

  let si = 0;
  for (let gi = 0; gi < groups.length; gi++){
    if (gi === fouadGroupIndex) continue;

    if (slots[si]){
      groups[gi].teeTime = slots[si].time;
      groups[gi].startHole = slots[si].startHole;
      si++;
    } else {
      groups[gi].teeTime = null;
      groups[gi].startHole = null;
    }
  }

  return groups;
}

/* ========= GROUPING / OUTPUT ========= */

function buildTodayPlayers(){
  const selectedMembers = getSelectedPlayers().map(name => ({
    name,
    hcp: (handicaps[name] ?? 0),
    type: "member"
  }));

  const guestPlayers = guests.map(g => ({
    name: g.name,
    hcp: g.hcp,
    type: "guest",
    host: (g.host || "").trim()
  }));

  return [...selectedMembers, ...guestPlayers];
}

function renderGroups(groups){
  const el = document.getElementById("groupsContainer");
  if (!groups.length){
    el.innerHTML = "<em>No hay grupos. Seleccione jugadores y genere pareos.</em>";
    return;
  }

  el.innerHTML = groups.map((g, idx) => {
    const teeLabel = g.teeTime
      ? `⏱ ${g.teeTime} — Hoyo ${g.startHole}`
      : `⚠️ Sin tee time asignado`;

    const rows = g.players.map(p => {
      const extra = p.type === "guest" ? ` <span class="badge">Invitado</span>` : "";
      const host = p.type === "guest" && p.host ? ` <span class="badge">Host: ${escapeHtml(p.host)}</span>` : "";
      return `<div>${escapeHtml(p.name)} <span class="strokes">(HCP: ${escapeHtml(p.hcp)})</span>${extra}${host}</div>`;
    }).join("");

    return `
      <div class="group-card">
        <div><strong>Grupo ${idx + 1}</strong> <span class="badge">${escapeHtml(teeLabel)}</span></div>
        <div style="margin-top:.35rem;">${rows}</div>
      </div>
    `;
  }).join("");
}

function renderMatchCards(groups){
  const gameFormat = document.getElementById("gameFormat").value;
  const el = document.getElementById("scorecardsContainer");

  if (gameFormat !== "match" || !groups.length){
    el.innerHTML = "<span class='note'>Seleccione “Match play” para mostrar tarjetas.</span>";
    return;
  }

  el.innerHTML = groups.map((g, idx) => {
    const p = g.players;
    const a = p[0]?.name || "—";
    const b = p[1]?.name || "—";
    const c = p[2]?.name || "—";
    const d = p[3]?.name || "—";
    const tee = g.teeTime ? `${g.teeTime} H${g.startHole}` : "Sin tee time";

    return `
      <div class="scorecard">
        <div><strong>Match Cards — Grupo ${idx+1}</strong> <span class="badge">${escapeHtml(tee)}</span></div>
        <div class="note" style="margin-top:.3rem;">
          1) ${escapeHtml(a)} vs ${escapeHtml(b)}<br>
          2) ${escapeHtml(c)} vs ${escapeHtml(d)}
        </div>
      </div>
    `;
  }).join("");
}

function buildWhatsAppText(groups){
  const lines = [];
  lines.push("Regina Golf – Pareos");
  lines.push("");

  groups.forEach((g, idx) => {
    const tee = g.teeTime ? `${g.teeTime} (H${g.startHole})` : "SIN TEE TIME";
    lines.push(`Grupo ${idx+1} — ${tee}`);
    g.players.forEach(p => {
      lines.push(`- ${p.name} (HCP ${p.hcp})${p.type==="guest" ? " [Invitado]" : ""}`);
    });
    lines.push("");
  });

  return lines.join("\n");
}

document.getElementById("generateBtn").addEventListener("click", () => {
  const today = buildTodayPlayers();
  if (today.length < 2){
    alert("Seleccione al menos 2 jugadores/invitados.");
    return;
  }

  const result = generateGroupsWithFouadAndOlgaRules(today);
  let groups = result.groups;
  groups = assignTeeSlotsToGroups(groups);

  lastGroups = groups;

  renderGroups(groups);
  renderMatchCards(groups);
  document.getElementById("exportText").value = buildWhatsAppText(groups);

  if (result.warnings.length){
    alert("⚠️ Avisos:\n" + result.warnings.join("\n"));
  }
});

/* ========= INIT ========= */
renderPlayers();
renderGuests();
renderGroups([]);
renderMatchCards([]);
</script>

</body>
</html>
