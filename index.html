<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Regina Golf App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA CONFIG -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#5B6F3A">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
  <!-- END PWA CONFIG -->

  <!-- Excel reader (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --green-dark:#5B6F3A;
      --green-mid:#8FA76A;
      --green-light:#C9D8A5;
      --bg-main:#F3F5EC;
    }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      margin: 0;
      padding: 1rem;
    }
    .app{
      max-width: 980px;
      margin: 0 auto;
      background:#fff;
      padding:1.5rem;
      border-radius:16px;
      border:3px solid var(--green-light);
      box-shadow:0 3px 10px rgba(0,0,0,.12);
    }
    .logo-wrap{text-align:center;margin-bottom:.5rem}
    .logo-img{max-width:140px;height:auto}
    h1{
      text-align:center;
      font-size:1.6rem;
      color:var(--green-dark);
      margin:.25rem 0 1rem;
    }
    h2{color:var(--green-dark); font-size:1.1rem; margin-top:1.5rem}
    h3{color:var(--green-dark); font-size:1rem; margin-top:1rem}

    .top-row{
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      border-bottom:1px solid var(--green-light);
      padding-bottom:.5rem;
      margin-bottom:1rem;
      align-items:center;
    }

    select,input,button,textarea{
      border-radius:6px;
      border:1px solid var(--green-light);
      font-size:.9rem;
      padding:.4rem .6rem;
    }
    button{
      background:var(--green-dark);
      color:#fff;
      border:none;
      cursor:pointer;
      transition:.15s;
    }
    button:hover{background:#4a5b30}

    .note{font-size:.82rem;color:#516044;margin:.2rem 0}
    .strokes{font-size:.75rem;color:#444}

    #playersContainer{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(210px,1fr));
      gap:.4rem;
      background:#fafcf7;
      border-radius:10px;
      padding:.5rem;
      border:1px solid var(--green-light);
    }
    .players-list label{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
    }

    .badge{
      display:inline-block;
      padding:.1rem .45rem;
      border-radius:999px;
      background:var(--green-light);
      color:#2f3a21;
      font-size:.75rem;
      margin-left:.35rem;
    }

    .guest-item{
      display:flex;
      justify-content:space-between;
      gap:.5rem;
      align-items:center;
      font-size:.85rem;
      margin:.25rem 0;
    }
    .guest-item button{
      background:#b84747;
      padding:.15rem .5rem;
      font-size:.7rem;
    }

    .group-card{
      margin:.4rem 0;
      background:#fafcf7;
      padding:.6rem .7rem;
      border-radius:10px;
      border:1px solid var(--green-light);
    }

    textarea{
      width:100%;
      min-height:90px;
      margin-top:.5rem;
      border-radius:8px;
      border:1px solid var(--green-light);
      padding:.5rem;
      background:#fafcf7;
    }

    table{width:100%; border-collapse:collapse; font-size:.88rem}
    th,td{border:1px solid #d7dfc9; padding:.35rem; text-align:center}
    th{background:var(--green-light); color:#2f3a21}
    td.left{text-align:left}

    .section-card{
      background:#fafcf7;
      border:1px solid var(--green-light);
      border-radius:12px;
      padding:.75rem;
      margin:.6rem 0;
    }

    .inline-actions{
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      align-items:center;
    }
  </style>
</head>

<body>
<div class="app">
  <div class="logo-wrap"><img src="regina-logo.png" class="logo-img" alt="Regina logo"></div>
  <h1>Regina Golf ‚Äì Pareo y Resultados</h1>

  <div class="top-row">
    <div>
      <label>Tipo de ronda:<br>
        <select id="roundType">
          <option value="regular">Ronda Regular</option>
          <option value="mensual">Torneo Mensual</option>
        </select>
      </label>
    </div>

    <div>
      <label>Formato de juego:<br>
        <select id="gameFormat">
          <option value="stroke">Stroke play</option>
          <option value="stableford">Stableford</option>
          <option value="match">Match play</option>
        </select>
      </label>
    </div>

    <button id="generateBtn">Generar Pareos</button>
    <button id="showResultsBtn" style="background:#8FA76A">Resultados</button>
  </div>

  <!-- Tee time selection -->
  <h2>Tee times</h2>
  <p class="note">Seleccione las horas disponibles para salida por hoyo 1 y hoyo 10.</p>

  <div class="top-row" style="align-items:flex-end;">
    <div style="min-width:260px;">
      <label>Hoyo 1 (selecci√≥n m√∫ltiple):<br>
        <select id="teeTimesHole1" multiple size="6" style="width:100%;">
          <option value="06:20">6:20</option>
          <option value="06:30">6:30</option>
          <option value="06:40">6:40</option>
          <option value="06:50">6:50</option>
          <option value="07:00">7:00</option>
          <option value="07:10">7:10</option>
        </select>
      </label>
    </div>

    <div style="min-width:260px;">
      <label>Hoyo 10 (selecci√≥n m√∫ltiple):<br>
        <select id="teeTimesHole10" multiple size="6" style="width:100%;">
          <option value="06:20">6:20</option>
          <option value="06:30">6:30</option>
          <option value="06:40">6:40</option>
          <option value="06:50">6:50</option>
          <option value="07:00">7:00</option>
          <option value="07:10">7:10</option>
        </select>
      </label>
    </div>

    <div style="min-width:220px;">
      <button id="applyTeeTimesBtn" style="background:#8FA76A">Usar seleccionados</button>
      <button id="clearTeeTimesBtn" style="background:#9da8a0">Limpiar</button>
    </div>
  </div>
  <div id="teeTimesSummary" class="note"></div>

  <!-- Excel upload -->
  <h2>Actualizar HCP (Excel)</h2>
  <p class="note">Suba un Excel con columnas: <strong>Nombre</strong> y <strong>HCP</strong> (o Handicap).</p>
  <div class="inline-actions">
    <input type="file" id="hcpExcelInput" accept=".xlsx,.xls" />
    <button id="applyHcpBtn" style="background:#8FA76A">Actualizar handicaps</button>
    <div id="hcpUploadStatus" class="note"></div>
  </div>

  <!-- Players -->
  <h2>Jugadores hoy</h2>
  <p class="note">Marque qui√©nes juegan hoy.</p>
  <div class="inline-actions">
    <button id="selectAllBtn" style="background:#8FA76A">Seleccionar todos</button>
    <button id="deselectAllBtn" style="background:#9da8a0">Deseleccionar todos</button>
  </div>
  <div id="playersContainer" class="players-list"></div>

  <!-- Guests -->
  <h2>Invitados</h2>
  <div class="inline-actions">
    <label>Anfitri√≥n:
      <select id="guestHostSelect"></select>
    </label>
    <input id="guestNameInput" placeholder="Nombre invitado">
    <input id="guestHcpInput" type="number" placeholder="HCP" style="width:120px;">
    <button id="addGuestBtn">Agregar invitado</button>
  </div>
  <div id="guestsList" class="note" style="margin-top:.5rem;"></div>

  <!-- Groups -->
  <h2>Pareos</h2>
  <div id="groupsContainer"></div>

  <h3>Copiar a WhatsApp</h3>
  <textarea id="exportText" readonly></textarea>

  <!-- Results -->
  <div id="scoresSection" style="display:none;">
    <h2>Resultados</h2>
    <p class="note">
      <strong>Regular:</strong> lista por HCP descendente. Ingrese Gross. Calcula Neto. Premios: 1¬∫/2¬∫ Gross, 1¬∫/2¬∫ Neto, y peor neto ‚ÄúLa Tanga‚Äù. <br>
      <strong>Mensual:</strong> Flight A (HCP &lt; 12) y Flight B (HCP ‚â• 12), cada flight por HCP descendente. Premios por flight: 1¬∫/2¬∫ Gross y 1¬∫/2¬∫ Neto. <strong>No se permiten ganadores duplicados</strong>.
    </p>

    <div class="inline-actions">
      <label>Fecha:
        <input id="roundDate" type="date">
      </label>
      <button id="buildResultsBtn" style="background:#8FA76A">Generar tabla</button>
      <button id="calcScoresBtn">Calcular resultados</button>
      <button id="hideResultsBtn" style="background:#9da8a0">Cerrar</button>
    </div>

    <div id="scoresTableContainer" style="margin-top:.6rem;"></div>
    <div id="scoresSummary" class="section-card" style="margin-top:.6rem;"></div>
  </div>
</div>

<script>
/* ========= DATA ========= */
const players = [
  "Gilberto Acosta","Phillippe Arnoux","Luis Beltran","Murielle Borgeaud",
  "Carlos Braddick","Olga Brooks","Hope Bullock III","Cecil Casasola",
  "Jose Casasola","Federico Cockburn","Manuel Cordova","Clarissa Corro",
  "Rodolfo Fuentes","David Gomez","Pedro Gonzalez","Carlos Gonzalez",
  "Luis Gordon","Cesar Hall","Edilberto Hernandez","Jose Leal",
  "Sara Lin","Luis Llorach","Sofia Llorach","Tony Martinez",
  "Fouad Moutran","Heriberto Olier","Julio Ortiz","BK Patel",
  "Raul Orillac","Rui Tulha","Daniel Ribeiro","Jose Serracin",
  "Pancho Townsend","Antonio Villarreal","Jose Von Chong"
];

const handicaps = {
  "Gilberto Acosta": -1,
  "Phillippe Arnoux": 21,
  "Luis Beltran": 19,
  "Murielle Borgeaud": 28,
  "Carlos Braddick": 11,
  "Olga Brooks": 11,
  "Hope Bullock III": 10,
  "Cecil Casasola": 6,
  "Jose Casasola": 7,
  "Federico Cockburn": 15,
  "Manuel Cordova": 40,
  "Clarissa Corro": 22,
  "Rodolfo Fuentes": 15,
  "David Gomez": 30,
  "Pedro Gonzalez": 5,
  "Carlos Gonzalez": 14,
  "Luis Gordon": 9,
  "Cesar Hall": 4,
  "Edilberto Hernandez": 8,
  "Jose Leal": 13,
  "Sara Lin": 27,
  "Luis Llorach": 20,
  "Sofia Llorach": 11,
  "Tony Martinez": 23,
  "Fouad Moutran": 8,
  "Heriberto Olier": 30,
  "Julio Ortiz": 7,
  "BK Patel": 10,
  "Raul Orillac": 14,
  "Rui Tulha": 15,
  "Daniel Ribeiro": 27,
  "Jose Serracin": 14,
  "Pancho Townsend": 13,
  "Antonio Villarreal": 22,
  "Jose Von Chong": 25
};

/* ========= STATE ========= */
let guests = [];            // {name, hcp, host}
let teeSlots = [];          // {time:"HH:MM", startHole:1|10}
let lastGroups = [];        // [{players:[{name,hcp,type,host?}], teeTime, startHole}]

/* ========= HELPERS ========= */
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normalizeName(s){
  return (s || "").toString().trim().replace(/\s+/g," ").toLowerCase();
}
function shuffle(arr){
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function sortByHcpDesc(arr){
  return arr.slice().sort((a,b)=>(b.hcp ?? 0)-(a.hcp ?? 0));
}

/* ========= RENDER PLAYERS / HOSTS ========= */
function renderPlayers(){
  const container = document.getElementById("playersContainer");
  container.innerHTML = players.map(p => {
    const h = (handicaps[p] ?? "‚Äî");
    return `
      <label>
        <input type="checkbox" class="playerCheck" value="${escapeHtml(p)}">
        ${escapeHtml(p)} <span class="strokes">(HCP: ${escapeHtml(h)})</span>
      </label>
    `;
  }).join("");

  const host = document.getElementById("guestHostSelect");
  host.innerHTML = `<option value="">(Seleccione anfitri√≥n)</option>` + players.map(p =>
    `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`
  ).join("");
}
document.getElementById("selectAllBtn").addEventListener("click", () => {
  document.querySelectorAll(".playerCheck").forEach(c => c.checked = true);
});
document.getElementById("deselectAllBtn").addEventListener("click", () => {
  document.querySelectorAll(".playerCheck").forEach(c => c.checked = false);
});

/* ========= GUESTS ========= */
function renderGuests(){
  const el = document.getElementById("guestsList");
  if (!guests.length){
    el.innerHTML = "<em>No hay invitados.</em>";
    return;
  }
  el.innerHTML = guests.map((g, idx) => `
    <div class="guest-item">
      <div>
        <strong>${escapeHtml(g.name)}</strong>
        <span class="badge">HCP: ${escapeHtml(g.hcp)}</span>
        <span class="badge">Host: ${escapeHtml(g.host || "‚Äî")}</span>
      </div>
      <button onclick="removeGuest(${idx})">X</button>
    </div>
  `).join("");
}
window.removeGuest = function(idx){
  guests.splice(idx,1);
  renderGuests();
};
document.getElementById("addGuestBtn").addEventListener("click", () => {
  const host = document.getElementById("guestHostSelect").value.trim();
  const name = document.getElementById("guestNameInput").value.trim();
  const hcp = Number(document.getElementById("guestHcpInput").value);

  if (!name){ alert("Ingrese nombre del invitado."); return; }
  if (!Number.isFinite(hcp)){ alert("Ingrese un HCP num√©rico."); return; }

  guests.push({ name, hcp, host });
  document.getElementById("guestNameInput").value = "";
  document.getElementById("guestHcpInput").value = "";
  renderGuests();
});

/* ========= TEE TIMES ========= */
const teeTimesHole1 = document.getElementById("teeTimesHole1");
const teeTimesHole10 = document.getElementById("teeTimesHole10");
const applyTeeTimesBtn = document.getElementById("applyTeeTimesBtn");
const clearTeeTimesBtn = document.getElementById("clearTeeTimesBtn");
const teeTimesSummary = document.getElementById("teeTimesSummary");

function getSelectedValues(selectEl){
  return Array.from(selectEl.selectedOptions).map(o => o.value);
}
function renderTeeSummary(){
  if (!teeSlots.length){
    teeTimesSummary.innerHTML = "<em>No hay tee times seleccionados.</em>";
    return;
  }
  const byHole = {1:[], 10:[]};
  teeSlots.forEach(s => byHole[s.startHole].push(s.time));
  teeTimesSummary.innerHTML =
    `<strong>Hoyo 1:</strong> ${byHole[1].join(", ") || "‚Äî"}<br>` +
    `<strong>Hoyo 10:</strong> ${byHole[10].join(", ") || "‚Äî"}`;
}
applyTeeTimesBtn.addEventListener("click", () => {
  const h1 = getSelectedValues(teeTimesHole1).sort();
  const h10 = getSelectedValues(teeTimesHole10).sort();
  teeSlots = [
    ...h1.map(t => ({ time:t, startHole:1 })),
    ...h10.map(t => ({ time:t, startHole:10 }))
  ];
  renderTeeSummary();
});
clearTeeTimesBtn.addEventListener("click", () => {
  teeSlots = [];
  Array.from(teeTimesHole1.options).forEach(o => o.selected = false);
  Array.from(teeTimesHole10.options).forEach(o => o.selected = false);
  renderTeeSummary();
});
function assignTeeSlotsToGroups(groups){
  for (let i=0;i<groups.length;i++){
    if (teeSlots[i]){
      groups[i].teeTime = teeSlots[i].time;
      groups[i].startHole = teeSlots[i].startHole;
    } else {
      groups[i].teeTime = null;
      groups[i].startHole = null;
    }
  }
  return groups;
}
renderTeeSummary();

/* ========= EXCEL UPLOAD ========= */
const hcpExcelInput = document.getElementById("hcpExcelInput");
const applyHcpBtn = document.getElementById("applyHcpBtn");
const hcpUploadStatus = document.getElementById("hcpUploadStatus");

function findHeaderIndex(headers, candidates){
  for (const c of candidates){
    const idx = headers.indexOf(normalizeName(c));
    if (idx !== -1) return idx;
  }
  return -1;
}
function parseNumber(val){
  if (val === null || val === undefined) return null;
  if (typeof val === "number") return val;
  const s = val.toString().trim().replace(",", ".");
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
applyHcpBtn.addEventListener("click", async () => {
  const file = hcpExcelInput.files?.[0];
  if (!file){
    hcpUploadStatus.textContent = "Seleccione un archivo Excel primero.";
    return;
  }

  try{
    const arrayBuffer = await file.arrayBuffer();
    const wb = XLSX.read(arrayBuffer, { type:"array" });

    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });

    if (!rows.length){
      hcpUploadStatus.textContent = "El archivo est√° vac√≠o.";
      return;
    }

    const headerRow = rows[0].map(h => normalizeName(h));
    const nameCol = findHeaderIndex(headerRow, ["nombre","name","player","jugador"]);
    const hcpCol  = findHeaderIndex(headerRow, ["hcp","handicap","index"]);

    if (nameCol === -1 || hcpCol === -1){
      hcpUploadStatus.innerHTML = "No encontr√© columnas v√°lidas. Use <strong>Nombre</strong> y <strong>HCP</strong>.";
      return;
    }

    const playerMap = new Map();
    players.forEach(p => playerMap.set(normalizeName(p), p));

    let updated = 0, skippedNotFound = 0, skippedBad = 0;

    for (let r=1;r<rows.length;r++){
      const row = rows[r];
      if (!row || row.length===0) continue;

      const rawName = row[nameCol];
      const rawHcp = row[hcpCol];

      const key = normalizeName(rawName);
      if (!key) continue;

      const canonical = playerMap.get(key);
      if (!canonical){ skippedNotFound++; continue; }

      const h = parseNumber(rawHcp);
      if (h === null){ skippedBad++; continue; }

      handicaps[canonical] = h;
      updated++;
    }

    renderPlayers();
    hcpUploadStatus.innerHTML =
      `Listo. Actualizados: <strong>${updated}</strong>. No encontrados: <strong>${skippedNotFound}</strong>. HCP inv√°lido: <strong>${skippedBad}</strong>.`;
  } catch (err){
    console.error(err);
    hcpUploadStatus.textContent = "Error leyendo el Excel. Revise el formato.";
  }
});

/* ========= PAIRINGS ========= */
function getSelectedMemberNames(){
  return Array.from(document.querySelectorAll(".playerCheck"))
    .filter(c => c.checked)
    .map(c => c.value);
}
function buildTodayPlayers(){
  const selectedMembers = getSelectedMemberNames().map(name => ({
    name,
    hcp: (handicaps[name] ?? 0),
    type: "member"
  }));
  const guestPlayers = guests.map(g => ({
    name: g.name,
    hcp: g.hcp,
    type: "guest",
    host: g.host || ""
  }));
  return [...selectedMembers, ...guestPlayers];
}
function generateGroups(list){
  const shuffled = shuffle(list);
  const groups = [];
  for (let i=0;i<shuffled.length;i+=4){
    groups.push({
      players: shuffled.slice(i, i+4),
      teeTime: null,
      startHole: null
    });
  }
  return groups;
}
function renderGroups(groups){
  const el = document.getElementById("groupsContainer");
  if (!groups.length){
    el.innerHTML = "<em>No hay grupos. Seleccione jugadores y genere pareos.</em>";
    return;
  }
  el.innerHTML = groups.map((g, idx) => {
    const teeLabel = g.teeTime ? `‚è± ${g.teeTime} ‚Äî Hoyo ${g.startHole}` : `‚ö†Ô∏è Sin tee time asignado`;
    const rows = g.players.map(p => {
      const extra = p.type === "guest" ? ` <span class="badge">Invitado</span>` : "";
      const host = p.type === "guest" && p.host ? ` <span class="badge">Host: ${escapeHtml(p.host)}</span>` : "";
      return `<div>${escapeHtml(p.name)} <span class="strokes">(HCP: ${escapeHtml(p.hcp)})</span>${extra}${host}</div>`;
    }).join("");

    return `
      <div class="group-card">
        <div><strong>Grupo ${idx+1}</strong> <span class="badge">${teeLabel}</span></div>
        <div style="margin-top:.35rem;">${rows}</div>
      </div>
    `;
  }).join("");
}
function buildWhatsAppText(groups){
  const lines = [];
  lines.push("Regina Golf ‚Äì Pareos");
  lines.push("");

  groups.forEach((g, idx) => {
    const tee = g.teeTime ? `${g.teeTime} (H${g.startHole})` : "SIN TEE TIME";
    lines.push(`Grupo ${idx+1} ‚Äî ${tee}`);
    g.players.forEach(p => {
      lines.push(`- ${p.name} (HCP ${p.hcp})${p.type==="guest" ? " [Invitado]" : ""}`);
    });
    lines.push("");
  });

  return lines.join("\n");
}
document.getElementById("generateBtn").addEventListener("click", () => {
  const today = buildTodayPlayers();
  if (today.length < 2){
    alert("Seleccione al menos 2 jugadores/invitados.");
    return;
  }

  let groups = generateGroups(today);
  groups = assignTeeSlotsToGroups(groups);
  lastGroups = groups;

  renderGroups(groups);
  document.getElementById("exportText").value = buildWhatsAppText(groups);

  // convenience: build results table
  renderResultsTable();
});

/* ========= RESULTS (NO DUPLICATE WINNERS) ========= */
function pickTopUnique(rows, key, count, excludeSet){
  const sorted = rows.slice().sort((a,b)=>(a[key] ?? Infinity) - (b[key] ?? Infinity));
  const picked = [];
  for (const r of sorted){
    if (excludeSet.has(r.name)) continue;
    picked.push(r);
    excludeSet.add(r.name);
    if (picked.length === count) break;
  }
  return picked;
}
function pickWorstUnique(rows, key, excludeSet){
  const sorted = rows.slice().sort((a,b)=>(b[key] ?? -Infinity) - (a[key] ?? -Infinity));
  for (const r of sorted){
    if (excludeSet.has(r.name)) continue;
    excludeSet.add(r.name);
    return [r];
  }
  return [];
}
function buildValidScores(rows){
  return rows
    .map(r => ({...r, gross: Number(r.gross), hcp: Number(r.hcp)}))
    .filter(r => Number.isFinite(r.gross) && Number.isFinite(r.hcp))
    .map(r => ({...r, net: r.gross - r.hcp}))
    .filter(r => Number.isFinite(r.net));
}
function calcRegularResultsUnique(rows){
  const valid = buildValidScores(rows);
  const used = new Set();
  const grossTop2 = pickTopUnique(valid, "gross", 2, used);
  const netTop2   = pickTopUnique(valid, "net",   2, used);
  const laTanga   = pickWorstUnique(valid, "net", used);
  return { grossTop2, netTop2, laTanga };
}
function calcMonthlyResultsUnique(rows){
  const valid = buildValidScores(rows).map(r => ({...r, flight: (r.hcp < 12 ? "A" : "B")}));
  const flightA = valid.filter(r => r.flight === "A");
  const flightB = valid.filter(r => r.flight === "B");

  const usedGlobal = new Set();

  function flightWinners(flightRows){
    const used = new Set([...usedGlobal]); // avoid duplicates with anything already chosen
    const grossTop2 = pickTopUnique(flightRows, "gross", 2, used);
    const netTop2   = pickTopUnique(flightRows, "net",   2, used);
    grossTop2.forEach(x => usedGlobal.add(x.name));
    netTop2.forEach(x => usedGlobal.add(x.name));
    return { grossTop2, netTop2 };
  }

  const A = flightWinners(flightA);
  const B = flightWinners(flightB);
  const laTanga = pickWorstUnique(valid, "net", usedGlobal);
  return { A, B, laTanga };
}

/* Build result rows from selected members + guests.
   Monthly excludes guests by default. */
function getResultsPlayers(){
  const roundType = document.getElementById("roundType").value;

  const members = getSelectedMemberNames().map(name => ({
    name,
    hcp: handicaps[name] ?? 0,
    gross: ""
  }));

  const guestRows = guests.map(g => ({
    name: g.name,
    hcp: g.hcp,
    gross: "",
    isGuest: true
  }));

  if (roundType === "mensual") return members;
  return [...members, ...guestRows];
}

function buildScoresTableHTML(rows){
  if (!rows.length) return `<p class="note"><em>No hay jugadores para resultados. Seleccione jugadores primero.</em></p>`;
  return `
    <table>
      <thead>
        <tr>
          <th>Jugador</th>
          <th>HCP</th>
          <th>Gross</th>
          <th>Net</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td class="left">${escapeHtml(r.name)}</td>
            <td>${escapeHtml(r.hcp)}</td>
            <td><input class="grossInput" type="number" min="0" data-name="${escapeHtml(r.name)}" data-hcp="${escapeHtml(r.hcp)}" style="width:90px;"></td>
            <td><span class="netCell">‚Äî</span></td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
function attachGrossListeners(){
  document.querySelectorAll(".grossInput").forEach(inp => {
    inp.addEventListener("input", () => {
      const gross = Number(inp.value);
      const hcp = Number(inp.dataset.hcp);
      const netCell = inp.closest("tr").querySelector(".netCell");
      if (!Number.isFinite(gross) || !Number.isFinite(hcp)) netCell.textContent = "‚Äî";
      else netCell.textContent = (gross - hcp);
    });
  });
}
function renderResultsTable(){
  const roundType = document.getElementById("roundType").value;
  const container = document.getElementById("scoresTableContainer");
  const rows = sortByHcpDesc(getResultsPlayers());

  if (roundType === "regular"){
    container.innerHTML = `<div class="section-card"><strong>Ronda Regular (HCP ‚Üì)</strong>${buildScoresTableHTML(rows)}</div>`;
  } else {
    const flightA = rows.filter(r => (r.hcp ?? 0) < 12);
    const flightB = rows.filter(r => (r.hcp ?? 0) >= 12);

    container.innerHTML =
      `<div class="section-card"><strong>Flight A (HCP &lt; 12) ‚Äî HCP ‚Üì</strong>${buildScoresTableHTML(flightA)}</div>` +
      `<div class="section-card"><strong>Flight B (HCP ‚â• 12) ‚Äî HCP ‚Üì</strong>${buildScoresTableHTML(flightB)}</div>`;
  }

  attachGrossListeners();
  document.getElementById("scoresSummary").innerHTML = `<em>Ingrese Gross y luego presione ‚ÄúCalcular resultados‚Äù.</em>`;
}
function readResultRowsFromInputs(){
  return Array.from(document.querySelectorAll(".grossInput")).map(inp => ({
    name: inp.dataset.name,
    hcp: Number(inp.dataset.hcp),
    gross: Number(inp.value)
  }));
}
function formatTop2(arr, label, key){
  if (!arr || arr.length === 0) return `${label}: ‚Äî`;
  const a = arr[0] ? `1¬∫ ${escapeHtml(arr[0].name)} (${arr[0][key]})` : "‚Äî";
  const b = arr[1] ? ` ¬∑ 2¬∫ ${escapeHtml(arr[1].name)} (${arr[1][key]})` : "";
  return `${label}: ${a}${b}`;
}
function formatOne(arr, label, key){
  if (!arr || arr.length === 0) return `${label}: ‚Äî`;
  return `${label}: ${escapeHtml(arr[0].name)} (${arr[0][key]})`;
}
document.getElementById("calcScoresBtn").addEventListener("click", () => {
  const roundType = document.getElementById("roundType").value;
  const rows = readResultRowsFromInputs();
  const summary = document.getElementById("scoresSummary");

  const filled = rows.filter(r => Number.isFinite(r.gross));
  if (filled.length < 2){
    summary.innerHTML = `<strong>Faltan datos</strong><br>Ingrese Gross para al menos 2 jugadores.`;
    return;
  }

  if (roundType === "regular"){
    const r = calcRegularResultsUnique(rows);
    summary.innerHTML = `
      <strong>Resultados ‚Äì Ronda Regular</strong><br><br>
      üèÜ ${formatTop2(r.grossTop2, "Gross", "gross")}<br>
      ü•á ${formatTop2(r.netTop2, "Neto", "net")}<br>
      ü©≤ ${formatOne(r.laTanga, "La Tanga (peor neto)", "net")}<br>
      <span class="note">* Sin ganadores duplicados.</span>
    `;
  } else {
    const m = calcMonthlyResultsUnique(rows);
    summary.innerHTML = `
      <strong>Resultados ‚Äì Torneo Mensual</strong><br><br>

      <strong>Flight A (HCP &lt; 12)</strong><br>
      üèÜ ${formatTop2(m.A.grossTop2, "Gross", "gross")}<br>
      ü•á ${formatTop2(m.A.netTop2, "Neto", "net")}<br><br>

      <strong>Flight B (HCP ‚â• 12)</strong><br>
      üèÜ ${formatTop2(m.B.grossTop2, "Gross", "gross")}<br>
      ü•á ${formatTop2(m.B.netTop2, "Neto", "net")}<br><br>

      ü©≤ ${formatOne(m.laTanga, "La Tanga (peor neto general)", "net")}<br>
      <span class="note">* Sin ganadores duplicados.</span>
    `;
  }
});

/* Show/hide results */
const scoresSection = document.getElementById("scoresSection");
document.getElementById("showResultsBtn").addEventListener("click", () => {
  scoresSection.style.display = "block";
  renderResultsTable();
  window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
});
document.getElementById("hideResultsBtn").addEventListener("click", () => {
  scoresSection.style.display = "none";
});
document.getElementById("buildResultsBtn").addEventListener("click", renderResultsTable);
document.getElementById("roundType").addEventListener("change", () => {
  if (scoresSection.style.display !== "none") renderResultsTable();
});

/* ========= INIT ========= */
renderPlayers();
renderGuests();
renderGroups([]);
document.getElementById("exportText").value = "";
</script>
</body>
</html>
